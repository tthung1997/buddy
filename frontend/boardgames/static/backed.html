<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <link rel="stylesheet" href="/static/style.css">
    <title>Incoming Games</title>
</head>

<body>
    <div class="container wide-container">
        <h1>Incoming Games</h1>
        <a href="/boardgames" class="button-link">Boardgames</a>
        {{if .Error}}
        <p><span class="error">Error: {{.Error}}</span></p>
        {{end}}
        {{if .Success}}
        <p><span class="success">{{.Success}}</span></p>
        {{end}}
        <form class="add-form" method="POST"
            action="{{if .AddName}}/boardgames/backed/edit{{else}}/boardgames/backed/add{{end}}"
            style="margin-bottom: 24px;">
            <input type="hidden" name="idx"
                value="{{if .AddName}}{{range $i, $game := .Items}}{{if eq $game.Name $.AddName}}{{$i}}{{end}}{{end}}{{end}}">
            <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-start;">
                <div style="display: flex; flex-direction: column;">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" required value="{{.AddName}}" class="form-input">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="delivery">Expected Delivery</label>
                    <input type="month" id="delivery" name="delivery" required
                        value="{{if .AddName}}{{range .Items}}{{if eq .Name $.AddName}}{{.Delivery}}{{end}}{{end}}{{end}}"
                        class="form-input">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="price">Price Paid</label>
                    <input type="number" id="price" name="price" required
                        value="{{if .AddName}}{{range .Items}}{{if eq .Name $.AddName}}{{.PricePaid}}{{end}}{{end}}{{end}}"
                        class="form-input">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="from">Backed/Preordered From</label>
                    <input type="text" id="from" name="from" required
                        value="{{if .AddName}}{{range .Items}}{{if eq .Name $.AddName}}{{.From}}{{end}}{{end}}{{end}}"
                        class="form-input">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="platform">Pledge Manager Platform</label>
                    <input type="text" id="platform" name="platform"
                        value="{{if .AddName}}{{range .Items}}{{if eq .Name $.AddName}}{{.Platform}}{{end}}{{end}}{{end}}"
                        class="form-input">
                </div>
                <div style="display: flex; flex-direction: column; justify-content: flex-end; height: 100%;">
                    <button type="submit" style="margin-top: 22px;">{{if .AddName}}Save Changes{{else}}Add
                        Boardgame{{end}}</button>
                </div>
            </div>
        </form>
        <form id="filter-form" style="margin-bottom: 16px;">
            <label>Show:</label>
            <label><input type="checkbox" class="filter-checkbox" value="received" checked> Received</label>
            <label><input type="checkbox" class="filter-checkbox" value="late" checked> Late</label>
            <label><input type="checkbox" class="filter-checkbox" value="waiting" checked> Waiting</label>
        </form>
        <div class="table-responsive">
            <table id="collectionTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Name &#x25B2;&#x25BC;</th>
                        <th onclick="sortTable(1)">Expected Delivery &#x25B2;&#x25BC;</th>
                        <th style="text-align: center;" onclick="sortTable(2)">Price Paid &#x25B2;&#x25BC;</th>
                        <th>Backed/Preordered From</th>
                        <th>Pledge Manager Platform</th>
                        <th style="text-align: center;">Received</th>
                        <th style="text-align: center;">Edit</th>
                    </tr>
                </thead>
                <tbody id="backed-tbody">
                    {{range $i, $game := .Items}}
                    <tr class="{{$game.RowClass}}"
                        data-status="{{if $game.Received}}received{{else if eq $game.RowClass "tr-late"}}late{{else}}waiting{{end}}">
                        <td>{{$game.Name}}</td>
                        <td>{{$game.Delivery}}</td>
                        <td style="text-align: center;">${{printf "%.2f" $game.PricePaid}}</td>
                        <td>{{$game.From}}</td>
                        <td>{{$game.Platform}}</td>
                        <td style="text-align: center;">
                            <input type="checkbox" class="received-checkbox" data-idx="{{$i}}"
                                {{if $game.Received}}checked{{end}}>
                        </td>
                        <td style="text-align: center;"><a href="/boardgames/backed/edit?idx={{$i}}"
                                class="small-table-btn">Edit</a></td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
</body>
<script>
    document.querySelectorAll('.received-checkbox').forEach(function(cb) {
        cb.addEventListener('change', function() {
            var idx = this.getAttribute('data-idx');
            var formData = new URLSearchParams();
            formData.append('idx', idx);
            formData.append('received', this.checked ? 'true' : 'false');
            fetch('/boardgames/backed/receive', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
            }).then(() => {
                window.location.reload();
            });
        });
    });
    // Table sorting (Name, Delivery, Price columns)
    function sortTable(n) {
        var table = document.getElementById("collectionTable");
        var rows = Array.from(table.tBodies[0].rows);
        var dir = table.getAttribute('data-sort-dir-' + n) || 'asc';
        var isNumeric = (n === 2); // Price column
        rows.sort(function (a, b) {
            var x = a.cells[n].innerText.trim();
            var y = b.cells[n].innerText.trim();
            if (isNumeric) {
                x = parseFloat(x.replace(/[^\d\.]/g, ''));
                y = parseFloat(y.replace(/[^\d\.]/g, ''));
            }
            if (dir === 'asc') {
                return x > y ? 1 : x < y ? -1 : 0;
            } else {
                return x < y ? 1 : x > y ? -1 : 0;
            }
        });
        while (table.tBodies[0].rows.length) {
            table.tBodies[0].deleteRow(0);
        }
        rows.forEach(function (row) {
            table.tBodies[0].appendChild(row);
        });
        table.setAttribute('data-sort-dir-' + n, dir === 'asc' ? 'desc' : 'asc');
    }

    function updateFilter() {
        var checked = Array.from(document.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
        var rows = document.querySelectorAll('#backed-tbody tr');
        rows.forEach(function(row) {
            if (checked.includes(row.getAttribute('data-status'))) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    document.querySelectorAll('.filter-checkbox').forEach(function(cb) {
        cb.addEventListener('change', updateFilter);
    });
    updateFilter();
</script>

</html>